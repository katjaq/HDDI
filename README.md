# Hypothesis-driven Diffusion Imaging

A model of axonal fibre growth in a brain.

This model aims at investigating how much of a the real connectivity of a brain can be reproduced from a set of minimal hypotheses:

1. Fibres grow from the neocortical surface until they reach another neuronal target,
2. Fibres occupy space, therefore, the density of the white matter is relatively homogeneous and bounded by physical constraints (in other words, all fibres cannot cross through the same point at the same time)
3. Fibres are sticky, their trajectory tends to follow the main anisotropy in their local substrate.

The code implements these hypotheses one after the other, growing fibres on a series of geometries. Some of these geometries are generated in the code (ellipsoid, parallelepiped), some are obtained from segmentations of real brains.

In addition to generating sets of fibres, the code can produce volumes with data similar to diffusion-weighted MRI (DWI) datasets. These volumes can be analysed as normal DWI data, and we use Mrtrix3 to generate tractograms.

Finally, we explore how much of the known patterns of brain connectivity can be reproduced by the model, for example, the perpendicular orientation of fibres in the gyral crowns, the parallel orientation of fibres in sulcal fundi, the bending of fibres at the exit of gyri, the graph-theoretical properties of the tractograms and their allometric scaling.

## Installing an running the code
After downloading, install the modules required by the code using

`npm install`

The different source code files and resources are combined into a single file using `Gulp`. To run all the gulp tasks, enter the command

`gulp`

Finally, run all the experiments by executing the `hddi.js` file using the command

`node hddi.js`

The results will be generated in the `results` directory inside each experiment.

## How does the code work

`app.js` is the main code file, it calls all the MRI interfaces and the `sim.js` simulation code.
Different experiments can be run on the model. Each experiment defines a geometry where the axons will be grown, and simulation parametres such as number of fibres, stiffness, etc.

## How to write a new experiment
Each experiment should be placed inside the `experiments` directory.
Inside the experiment directory, a file `script.js` should contain the experiment code and a `results` directory should contain the results.
This is, for example, the structure of the "ellipsoid" experiment `script.js` code:

1. The `params` structure is defined, which contains all the parametres models, including fibre stiffness, minimum fibre length, number of fibres to generate, gradient table for the DWI simulation,
2. The `wdir` variable is declared, which contains the path to the `results` directory,
3. The geometry is generated, in this case, an ellipsoid,
4. The surface, core and background of the model are identified with the `identifyVoxels` function,
5. Streamlines are generated,
6. A B0 volume is generated,
7. The results are saved and merged so as to make them suitable for tractography analysis,
8. The tractography reconstruction is launched.

Finally, the compilation of all the different code files into the single, final code file is done using `Gulp`. The list of experiments to be run is contained in the array `experimentFiles`.

## File organisation

<pre>
├─.eslintrc.js        Linting rules for the code
├─.git                Git folder (never touch!)
├─.gitignore          List of files that we don't want git to track
├─data/               Brain segmentations
|
├─experiments/        Experiments code
| ├─01-ellipsoid        experiment 1: growth on an ellipsoid
| | ├─results/            results, generated by the simulation (initially empty)
| | ├─script.js           experiment script and parameters
| |
| |─02-rectangle        experiment 2: growth on a parallelepiped
|   ├─results/            results generated by the simulation (initially empty)
|   ├─script.js           experiment script
| 
├─gulpfile.js         List of gulp tasks for building the final code
├─hddi.js             The final code, generated by Gulp (do not edit directly)
├─interfaces/         Javascript interfaces to neuroimaging packages
| ├─fsl.js
| ├─mrtrix.js
|
├─node_modules/       Modules installed by `npm install`, not tracked by git
|
├─package-lock.json   Generated by npm
├─package.json        Generated by npm
├─previous/           Previous code, kept for reference
|
├─ReadMe.Md           This ReadMe file
├─src/                Source code
| ├─app.js              The main app code
| ├─dti-test.js         Test of the dti.js code
| ├─dti.js              Diffusion tensor fitting
| ├─extend.js           The `extend` function, used to extend js objects
| ├─gtable-6.txt        An example DWI gradient table with 6 directions
| ├─gui.js              GUI code (not used in the offline version)
| ├─mii.js              Nifti1 help functions
| ├─sim.js              The model code
|
├─web/                Files for the web version of the code
  ├─favicon.ico
  ├─img/
  |
  ├─index.html
  ├─main.css
</pre>